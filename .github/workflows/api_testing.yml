name: CI Pipeline - API Tests
'on':
  push:
    branches:
      - main
  pull_request:
    branches:
      - main
  schedule:
    - cron: 30 3 * * *
  workflow_dispatch: null
jobs:
  run-tests:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout source code
        uses: actions/checkout@v4
      - name: Set up JDK
        uses: actions/setup-java@v4
        with:
          distribution: temurin
          java-version: '21'
      - name: Set up Maven
        uses: actions/cache@v4
        with:
          path: ~/.m2
          key: '${{ runner.os }}-maven-${{ hashFiles(''**/pom.xml'') }}'
          restore-keys: |
            ${{ runner.os }}-maven-
      - name: Build with Maven
        run: mvn clean test
      - name: Debug â€“ find extent report
        if: always()
        run: |
          echo "Searching for Extent reports..."
          find . -iname "*extent*.html"
      - name: List generated txt files
        if: success()
        run: ls -l *.txt
      - name: Upload Extent Report
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: ExtentReport
          path: target/extent-report/
      - name: List test-output folder
        if: always()
        run: |
          echo "Current directory:"
          pwd
          echo "Listing files:"
          ls -R
      - name: Send email with attachment
        if: success()
        uses: dawidd6/action-send-mail@v3
        with:
          server_address: '${{ secrets.SMTP_SERVER }}'
          server_port: '${{ secrets.SMTP_PORT }}'
          username: '${{ secrets.SMTP_USERNAME }}'
          password: '${{ secrets.SMTP_PASSWORD }}'
          subject: GitHub Job Success - API Automation
          body: |
            Hi,

            The GitHub Actions job has completed successfully.
            Please find the attached output file.

            Regards,
            GitHub Actions
          to: '${{ secrets.MAIL_TO }}'
          from: 'GitHub Actions <${{ secrets.SMTP_USERNAME }}>'
          attachments: '*.txt'
      - name: Verify secrets
  run: echo "Secrets loaded successfully"
